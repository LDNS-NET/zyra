
Done — I implemented the full automated WireGuard onboarding flow in the repo and added server-side pieces. Summary, what changed, and exactly what you must do next to enable it.

What I added/changed

mikrotik_onboarding.rsc.stub
Injected an automated WireGuard block: create WG interface, try to read RouterOS public key, add server peer, and phone-home with wg_public_key/wg_address to the app sync URL.
DB migration
2025_11_12_000001_add_wireguard_fields_to_tenant_mikrotiks_table.php
Adds: wireguard_public_key, wireguard_allowed_ips, wireguard_address, wireguard_port, wireguard_status, wireguard_last_handshake.
Model
TenantMikrotik.php
Added WG fields to $fillable and casts.
Script generator
MikrotikScriptGenerator.php
Replacements for {{wg_server_endpoint}}, {{wg_server_pubkey}}, {{wg_subnet}}, {{wg_port}} injected into onboarding script.
Controller
TenantMikrotikController.php
Added public token-authenticated endpoint registerWireguard to receive wg_public_key and optional wg_address, store them and dispatch a job to apply the peer.
Public route
web.php
POST /mikrotiks/{mikrotik}/register-wireguard registered (token-based; public route like existing /sync).
WireGuard server integration
WireGuardService.php
Uses Symfony Process to run wg commands via sudo to add/update peers; sets router->wireguard_status accordingly.
Background processing
ApplyWireGuardPeer.php — queued job that calls WireGuardService.
SyncWireguardPeers.php — artisan command to enqueue peers (scheduled or manual).
Config + service provider
wireguard.php — config keys and defaults.
AppServiceProvider.php — singleton binding for WireGuardService.
How it works (flow)

Tenant creates router record as before — UI shows onboarding script.
Router runs onboarding script (now includes WG block). Router attempts to create WG interface and phone-home its wg_public_key (and local wg_address if available) to /mikrotiks/{id}/register-wireguard?token=...
Controller validates sync_token, stores public key and optional address, creates a router log and dispatches ApplyWireGuardPeer job.
ApplyWireGuardPeer calls WireGuardService->applyPeer which runs wg set ... to add/update the peer on your droplet wg interface.
Router will handshake outbound (NAT-traversal) and become reachable via the tunnel IP. The app stores status and the assigned allowed-ips/address.
Immediate actions you must run on the server (concise)

Add config keys to .env:
WG_SERVER_ENDPOINT=your.droplet.ip.or.dns
WG_SERVER_PUBLIC_KEY=server_public_key_base64
WG_SUBNET=10.254.0.0/16 (or your chosen subnet)
WG_SERVER_PORT=51820
WG_INTERFACE=wg0
Run migration:
php artisan migrate
Install wg and ensure wg0 exists and server is listening:
apt/yum install wireguard
configure wg0 on droplet (server private key, ListenPort, Address=10.254.0.1/16)
Create a safe wrapper and sudoers entry (recommended)
Create script /usr/local/bin/zisp-wg-apply that runs the actual wg or wg-quick commands; example wrapper should accept a single command string and execute with /usr/bin/wg or wg-quick.
Add a limited sudoers rule to allow the app user (www-data or your PHP user) to run that wrapper without password.
This is more secure than allowing arbitrary sudo.
Ensure PHP process can run Symfony Process and sudo wrapper:
composer require symfony/process (if not present)
Start queue worker for wireguard queue:
php artisan queue:work --queue=wireguard --tries=3
Use supervisor/systemd in production.
Optionally schedule the artisan command:
Add to cron or scheduler: php artisan wireguard:sync-peers (or add to schedule in Console/Kernel).
Test:
Download and run the onboarding script on a RouterOS v7+ device.
Watch laravel.log for register-wireguard activity and job dispatch.
On server, run wg show (or wg show wg0) to confirm peer appears and handshake timestamp updates.
Check router record in app: wireguard_status should change to active.
Security notes (important)

The onboarding uses the router's sync_token to authenticate phone-home; do not disable token checks.
The app stores only public keys — never store router private keys.
Limit allowed-ips to the single tunnel address (/32) by default. Do not blindly allow entire subnets unless intentional.
Expose sync endpoints only over HTTPS.
Use a sudo wrapper with restrictive sudoers entries; do not grant full shell access.
